// chaira-ng-cordova - v0.1.0 (2016-11-24)
// http://github.com/florenciajs/ng-chaira-oauth
angular.module("Chaira",["Chaira.oauth","Chaira.utils","Chaira.provider"]).config(function(a){a.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded"}),function(){function a(){this.init=function(a){this.config=a},this.$get=function(){return this}}angular.module("Chaira.provider",[]).provider("Chaira",a),a.$inject=[]}(),function(){function a(a,b,c){return{refreshToken:function(a){b.post("http://chaira.udla.edu.co/api/v0.1/oauth2/authorize.asmx/refreshToken",{grant_type:"refresh_token",refresh_token:c.localStorage.refresh_token,client_id:a,state:"xyz"}).then(function(a){return console.log("si hay respuesta"),"OK"==a.data.state?(c.localStorage.token=a.data.access_token,c.localStorage.refresh_token=a.data.refresh_token,{state:"OK"}):{state:"error",detail:a.data.description}}).catch(function(a){return{state:"error",detail:"Ha ocurrido un problema"}})},isInAppBrowserInstalled:function(){var a=cordova.require("cordova/plugin_list"),b=["cordova-plugin-inappbrowser","cordova-plugin-inappbrowser.inappbrowser","org.apache.cordova.inappbrowser"];if(0===Object.keys(a.metadata).length){var c=a.map(function(a){return a.id||a.pluginId});return b.some(function(a){return c.indexOf(a)!=-1})}return b.some(function(b){return a.metadata.hasOwnProperty(b)})}}}angular.module("Chaira.utils",[]).factory("$cordovaChairaUtility",a),a.$inject=["$q","$http","$window"]}(),function(){"use strict";function a(a,b,c,d,e){return{oauth:function(f){var g=a.defer();if(window.cordova)if(d.isInAppBrowserInstalled()){var h="http://localhost/callback",i="http://chaira.udla.edu.co/api/v0.1/oauth2/authorize.asmx/auth?client_id="+e.config.client_id+"&redirect_uri="+h+"&response_type="+f+"&state=xyz",j=!0,k=window.cordova.InAppBrowser.open(i,"_blank","location=no,clearsessioncache=yes,clearcache=yes,zoom=no,hidden=yes");k.addEventListener("loadstart",function(a){if(k.addEventListener("loaderror",function(){k.close(),j=!1,g.reject("problema de red")}),k.addEventListener("loadstop",function(){k.executeScript({code:'document.getElementsByTagName("pre")[0].innerHTML'},function(a){var b=JSON.parse(a).state;"error"==b?(k.close(),j=!1,g.reject(JSON.parse(a).description)):(k.insertCSS({code:"body {background-color:"+e.config.login_bg_color+"}"}),k.show())})}),0===a.url.indexOf(h)){k.removeEventListener("exit",function(a){}),k.close(),j=!1;for(var d="code"==f?a.url.split("?")[1]:a.url.split("#")[1],i=d.split("&"),l=[],m=0;m<i.length;m++)l[i[m].split("=")[0]]=i[m].split("=")[1];void 0!==l.access_token&&null!==l.access_token||void 0!==l.code&&null!==l.code?"code"==f?b.post("http://chaira.udla.edu.co/api/v0.1/oauth2/authorize.asmx/token",{grant_type:"authorization_code",code:l.code,client_id:e.config.client_id,client_secret:e.config.client_secret,redirect_uri:h}).then(function(a){"OK"==a.data.state?(c.localStorage.token=a.data.access_token,c.localStorage.refresh_token=a.data.refresh_token,g.resolve(a.data)):g.reject(a.data.description)}).catch(function(a){g.reject("Ha ocurrido un problema")}):(c.localStorage.token=l.access_token,g.resolve({access_token:l.access_token,expires_in:l.expires_in})):0!==a.url.indexOf("error_code=100")?g.reject("Chaira returned error_code=100: Invalid permissions"):g.reject("Ha ocurrido un problema")}}),k.addEventListener("exit",function(a){j&&g.reject("El proceso ha sido cancelado")})}else g.reject("No se encontr칩 el plugin InAppBrowser");else g.reject("No se puede autenticar desde el navegador web");return g.promise},query:function(f){var g=a.defer();return b.post("http://chaira.udla.edu.co/api/v0.1/oauth2/resource.asmx/scope",{access_token:c.localStorage.token,scope:f}).then(function(a){if("OK"==a.data.type)g.resolve(a.data);else if("invalid_token"==a.data.type)if(null!==c.localStorage.refresh_token){var b=a.data.description;d.refreshToken(e.config.client_id).success(function(a){"OK"==a.state?(c.localStorage.token=a.access_token,c.localStorage.refresh_token=a.refresh_token,g.resolve({state:"OK",description:b,type:"OK"})):(console.log("No se pudo refrescar el token"),g.reject({state:"error",detail:a.description}))}).error(function(a){console.log("ocurrion un error"),g.reject({state:"error",detail:"No se obtuvo respuesta del servidor"})})}else g.resolve("No existe token de autenticaci칩n, debe iniciar sesi칩n");else g.reject(a.data.description),console.log(a.data)}).catch(function(a){g.reject({state:"error",detail:"El servicio no est치 disponible"})}),g.promise}}}angular.module("Chaira.oauth",["Chaira.utils","Chaira.provider"]).factory("$Chaira",a),a.$inject=["$q","$http","$window","$cordovaChairaUtility","Chaira"]}();